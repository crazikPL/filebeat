---
{% if es_filebeat_systemlogs %}
filebeat.inputs:
- type: log

  # Change to true to enable this input configuration.
  enabled: true

  # Paths that should be crawled and fetched. Glob based paths.
  paths:
{% for path in es_filebeat_system_paths %}
    - {{ path }}
{% endfor %}
    #- c:\programdata\elasticsearch\logs\*
{% endif %}

#============================= Filebeat inputs ================================
filebeat.config.inputs:
    enabled: true
    path: inputs.d/*.yml
    reload.enabled: true
    reload.period: 30s

#============================= Filebeat modules ===============================

filebeat.config.modules:
  # Glob pattern for configuration loading
  path: ${path.config}/modules.d/*.yml

  # Set to true to enable config reloading
  reload.enabled: true

  # Period on which files under path should be checked for changes
  reload.period: 30s

{% if es_filebeat_docker %}
#============================= autodiscovery docker containers ===============

filebeat.autodiscover:
  providers:
    - type: docker
      hints.enabled: true
      containers.ids:
        - "*"
      config:
      exclude_lines: ["^\\s+[\\-`('.|_]"]  # drop asciiart lines
      json.message_key: message
      json.keys_under_root: true
      json.overwrite_keys: true
      json.add_error_key: false
      json.ignore_decoding_error: true
      processors:
        - add_docker_metadata: ~

{% endif %}
#================================ General =====================================

# Workaround for https://discuss.elastic.co/t/filebeat-and-glibc-errors-on-ubuntu-22-04/306653/2
# on older versions of filebeat

{% if ansible_distribution == 'Ubuntu' and (ansible_distribution_version.split('.')[0] | int) >= 22 %}
# This config only applies to Ubuntu 22.04+ or later

seccomp:
  default_action: allow
  syscalls:
  - action: allow
    names:
    - rseq
{% endif %}

# The name of the shipper that publishes the network data. It can be used to group
# all the transactions sent by a single shipper in the web interface.
#name:

# The tags of the shipper are included in their own field with each
# transaction published.
#tags: ["service-X", "web-tier"]
{% if es_filebeat_main_tags %}
tags:
{% for tag in es_filebeat_main_tags %}
  - {{ tag }}
{% endfor %}
{% endif %}

# Optional fields that you can specify to add additional information to the
# output.
#fields:
#  env: staging

#============================== Dashboards =====================================
#setup.dashboards.enabled: false
#setup.dashboards.url:

#============================== Kibana =====================================
setup.kibana:
  #host: "localhost:5601"
  #space.id:

#============================= Elastic Cloud ==================================
# The cloud.id setting overwrites the `output.elasticsearch.hosts` and
# `setup.kibana.host` options.
# You can find the `cloud.id` in the Elastic Cloud web UI.
#cloud.id:

# The cloud.auth setting overwrites the `output.elasticsearch.username` and
# `output.elasticsearch.password` settings. The format is `<user>:<pass>`.
#cloud.auth:

#================================ Outputs =====================================

# Configure what output to use when sending the data collected by the beat.

#-------------------------- Elasticsearch output ------------------------------
#output.elasticsearch:
  # Array of hosts to connect to.
  #hosts: ["localhost:9200"]

  # Optional protocol and basic auth credentials.
  #protocol: "https"
  #username: "elastic"
  #password: "changeme"

#----------------------------- Logstash output --------------------------------
output.logstash:
  # The Logstash hosts
  hosts: [ {% for ls_host in es_filebeat_logstash_hosts %}"{{ ls_host }}:{{ es_filebeat_logstash_port }}"{{ ',' if not loop.last else '' }}{% endfor %} ]
  ttl: 30
  pipelining: 0

  # Optional SSL. By default is off.
  # List of root certificates for HTTPS server verifications
  #ssl.certificate_authorities: ["/etc/pki/root/ca.pem"]

  # Certificate for SSL client authentication
  #ssl.certificate: "/etc/pki/client/cert.pem"

  # Client Certificate Key
  #ssl.key: "/etc/pki/client/cert.key"

#================================ Procesors =====================================

# Configure processors to enhance or manipulate events generated by the beat.

processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~

#================================ Logging =====================================

# Sets log level. The default log level is info.
# Available log levels are: error, warning, info, debug
logging.level: info
logging.metrics.enabled: false

# At debug level, you can selectively enable logging only for some components.
# To enable all selectors use ["*"]. Examples of other selectors are "beat",
# "publish", "service".
#logging.selectors: ["*"]

max_procs: 1

#============================== Xpack Monitoring ===============================
# filebeat can export internal metrics to a central Elasticsearch monitoring
# cluster.  This requires xpack monitoring to be enabled in Elasticsearch.  The
# reporting is disabled by default.

# Set to true to enable the monitoring reporter.
xpack.monitoring.enabled: {{ es_filebeat_monitoring }}

# Uncomment to send the metrics to Elasticsearch. Most settings from the
# Elasticsearch output are accepted here as well. Any setting that is not set is
# automatically inherited from the Elasticsearch output configuration, so if you
# have the Elasticsearch output configured, you can simply uncomment the
# following line.
{% if es_filebeat_monitoring %}
xpack.monitoring.elasticsearch.hosts: "http://{{ es_elastic_coordination }}:9200/"
{% endif %}

